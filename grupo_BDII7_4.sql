--DROPS--
SET AUTOCOMMIT on; 
SET SERVEROUTPUT on;
 
-- Drops entidades
DROP TABLE VEHICULO CASCADE CONSTRAINTS; 
DROP TABLE VEHICULO_REFRIGERADO CASCADE CONSTRAINTS; 
DROP TABLE VEHICULO_ADR CASCADE CONSTRAINTS; 
DROP TABLE GPS CASCADE CONSTRAINTS; 
DROP TABLE PARADA CASCADE CONSTRAINTS; 
DROP TABLE RUTA CASCADE CONSTRAINTS; 
DROP TABLE ENVIO CASCADE CONSTRAINTS; 
DROP TABLE PAQUETE CASCADE CONSTRAINTS; 
DROP TABLE CLIENTE CASCADE CONSTRAINTS; 
DROP TABLE PERSONA CASCADE CONSTRAINTS; 
DROP TABLE EMPRESA CASCADE CONSTRAINTS; 
DROP TABLE EMPLEADO CASCADE CONSTRAINTS; 
DROP TABLE MECANICO CASCADE CONSTRAINTS; 
DROP TABLE ADMINISTRATIVO CASCADE CONSTRAINTS; 
DROP TABLE CONDUCTOR CASCADE CONSTRAINTS; 
-- Drops relaciones
DROP TABLE EJECUCION CASCADE CONSTRAINTS; 
DROP TABLE EJECUCION_CONDUCTOR CASCADE CONSTRAINTS; 
DROP TABLE SUPERVISA CASCADE CONSTRAINTS; 
--Drops vistas--
DROP VIEW VISTA_CLIENTE_PERSONA CASCADE CONSTRAINTS;
DROP VIEW VISTA_EMPLEADO_CONDUCTOR CASCADE CONSTRAINTS;
DROP VIEW VISTA_EJECUCION CASCADE CONSTRAINTS;
--Drops indices--
DROP INDEX IND_VEHICULO_EMPLEADO;
DROP INDEX IND_PARADA_RUTA;
DROP INDEX IND_ENVIO_CLIENTE;
DROP INDEX IND_EJECUCION_VEHICULO;
DROP INDEX IND_EJECUCION_RUTA;
DROP INDEX IND_EMPLEADO_DNI;
DROP INDEX IND_CLIENTE_ID;
DROP INDEX IND_EMPLEADO_NOMBRE;
DROP INDEX IND_CONDUCTOR_HORAS;
DROP INDEX IND_FECHA;
DROP INDEX IND_ESTADO;
DROP INDEX IND_EJECUCION_VEHICULO_FECHA;
DROP INDEX IND_EJECUCION_VEHICULO_RUTA;
DROP INDEX IND_PARADA_CIUDAD_RUTA;
DROP INDEX IND_SUPERVISA_SUPERVISADO;
DROP INDEX IND_EJEC_CONDUCTOR_EMPLEADO;

--CREACION TABLAS--
CREATE TABLE GPS
(
	ID_GPS	VARCHAR(9) NOT NULL,
	MODELO 	VARCHAR(10),
	NUM_SERIE	VARCHAR(10),
	PRIMARY KEY (ID_GPS)
);

CREATE TABLE EMPLEADO
(
	ID_EMPLEADO 	VARCHAR(10) NOT NULL,
	TELEFONO		NUMBER(9),
	NOMBRE_COMPLETO VARCHAR(40),
	NSS	VARCHAR(12),
	DNI	VARCHAR(9),
	PRIMARY KEY(ID_EMPLEADO)
);

CREATE TABLE CONDUCTOR
(
	ID_EMPLEADO VARCHAR(10) NOT NULL,
	LICENCIA VARCHAR(10),
	HORAS_SEMANA NUMBER(2),
	PRIMARY KEY (ID_EMPLEADO),
	FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO) ON DELETE CASCADE
	CHECK(HORAS_SEMANA >= 0)
);

CREATE TABLE MECANICO
(
	ID_EMPLEADO VARCHAR(10) NOT NULL,
	ESPECIALIDAD VARCHAR(40),
    PRIMARY KEY(ID_EMPLEADO),
    FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO) ON DELETE CASCADE
);

CREATE TABLE ADMINISTRATIVO
(
	ID_EMPLEADO VARCHAR(10) NOT NULL,
	DEPARTAMENTO VARCHAR(12),
	PRIMARY KEY (ID_EMPLEADO),
	FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO) ON DELETE CASCADE
);

CREATE TABLE VEHICULO (
    ID_VEHICULO   VARCHAR(5) NOT NULL,
    ID_GPS        VARCHAR(9) NOT NULL,
    ID_EMPLEADO   VARCHAR(10),
    MATRICULA     VARCHAR(7) UNIQUE,
    CAPACIDAD_KG  NUMBER(4),
    PRIMARY KEY (ID_VEHICULO),
    FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO) ON DELETE CASCADE,
    FOREIGN KEY (ID_GPS) REFERENCES GPS(ID_GPS) ON DELETE CASCADE
	CHECK(CAPACIDAD >= 0)
);

CREATE TABLE VEHICULO_REFRIGERADO(
    ID_VEHICULO	VARCHAR(5) NOT NULL,
    TEMP_MIN 		NUMBER(2),
    TEMP_MAX		NUMBER(2),
    PRIMARY KEY (ID_VEHICULO),
    FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULO (ID_VEHICULO) ON DELETE CASCADE
	CHECK(TEMP_MAX>TEMP_MIN)
);

CREATE TABLE VEHICULO_ADR
(
	ID_VEHICULO VARCHAR(5) NOT NULL,
	CLASEMERCANCIA VARCHAR (10),
	PRIMARY KEY(ID_VEHICULO),
	FOREIGN KEY(ID_VEHICULO) REFERENCES VEHICULO (ID_VEHICULO) ON DELETE CASCADE
	CHECK (CLASEMERCANCIA IN ('1','2','3','4.1','4.2','4.3','5.1','5.2','6.1','6.2','7','8','9')
);

CREATE TABLE RUTA
(
	ID_RUTA	VARCHAR(8) NOT NULL,
	NOMBRE	VARCHAR(16),
	DISTANCIA_KM NUMBER(4),
	PRIMARY KEY (ID_RUTA)
	CHECK(DISTANCIA_KM>0)
);

CREATE TABLE PARADA
(
	N_PARADA NUMBER(2) NOT NULL,
	ID_RUTA VARCHAR(8) NOT NULL,
	CIUDAD VARCHAR(9),
	HORAPREVISTA DATE,
	PRIMARY KEY(N_PARADA, ID_RUTA),
	FOREIGN KEY(ID_RUTA) REFERENCES RUTA(ID_RUTA) ON DELETE CASCADE
);

CREATE TABLE CLIENTE
(
	ID_CLIENTE VARCHAR(5) NOT NULL,
	NOMBRE VARCHAR(9),
	TELEFONO NUMBER(9),
	PRIMARY KEY(ID_CLIENTE)
);

CREATE TABLE PERSONA
(
	ID_CLIENTE	VARCHAR(5) NOT NULL,
	DNI		VARCHAR(9),
	NOMBRE_COMPLETO	VARCHAR(40),
	PRIMARY KEY(DNI),
	FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE) ON DELETE CASCADE
);

CREATE TABLE EMPRESA
(
	ID_CLIENTE VARCHAR(5) NOT NULL,
	NIF VARCHAR(9),
	NOMBREEMPRESA VARCHAR(40),
	PRIMARY KEY(NIF),
    FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE) ON DELETE CASCADE
);

CREATE TABLE ENVIO
(
    ID_ENVIO 	VARCHAR (10) NOT NULL,
    ID_CLIENTE VARCHAR(5) NOT NULL,
    FECHA	DATE,
    ESTADO 	VARCHAR(10)  NOT NULL,
    PRIMARY KEY (ID_ENVIO),
    FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTE(ID_CLIENTE) ON DELETE CASCADE
	CHECK(ESTADO IN ('Entregado','Pendiente','En camino'))
);

CREATE TABLE PAQUETE
(
    N_PAQUETE 	NUMBER(4) NOT NULL,
    ID_ENVIO 		VARCHAR (10) NOT NULL,
    PESO 			NUMBER(5),
    CONTENIDO 		VARCHAR(30),
    PRIMARY KEY (N_PAQUETE,ID_ENVIO),	
    FOREIGN KEY (ID_ENVIO) REFERENCES ENVIO(ID_ENVIO) ON DELETE CASCADE
	CHECK(N_PAQUETE >= 0 AND PESO >= 0)
);

CREATE TABLE EJECUCION
(
	ID_EJECUCION VARCHAR(5) NOT NULL,
	FECHA_EJECUCION DATE NOT NULL,
	ID_VEHICULO VARCHAR (5) NOT NULL,
	ID_RUTA VARCHAR(8) NOT NULL,
	PRIMARY KEY(ID_EJECUCION),
	FOREIGN KEY (ID_VEHICULO) REFERENCES VEHICULO(ID_VEHICULO) ON DELETE CASCADE,
    FOREIGN KEY (ID_RUTA) REFERENCES RUTA(ID_RUTA) ON DELETE CASCADE
);

CREATE TABLE EJECUCION_CONDUCTOR
(
	ID_EJECUCION VARCHAR(5)  NOT NULL,
    ID_EMPLEADO VARCHAR(10) NOT NULL,
    PRIMARY KEY(ID_EJECUCION, ID_EMPLEADO),
    FOREIGN KEY (ID_EJECUCION) REFERENCES EJECUCION(ID_EJECUCION) ON DELETE CASCADE,
    FOREIGN KEY (ID_EMPLEADO) REFERENCES EMPLEADO(ID_EMPLEADO) ON DELETE CASCADE
);

CREATE TABLE SUPERVISA
(
	ID_EMPLEADO_SUPERVISADO VARCHAR(10) NOT NULL,
	ID_EMPLEADO_SUPERVISOR VARCHAR(10) NOT NULL,
	PRIMARY KEY(ID_EMPLEADO_SUPERVISOR, ID_EMPLEADO_SUPERVISADO),
	FOREIGN KEY (ID_EMPLEADO_SUPERVISOR) REFERENCES EMPLEADO(ID_EMPLEADO) ON DELETE CASCADE,
	FOREIGN KEY (ID_EMPLEADO_SUPERVISADO) REFERENCES EMPLEADO(ID_EMPLEADO) ON DELETE CASCADE
);

--CREACION DE VISTAS--
CREATE OR REPLACE VIEW VISTA_CLIENTE_PERSONA AS 
    SELECT C.ID_CLIENTE, C.NOMBRE, C.TELEFONO, P.DNI, P.NOMBRE_COMPLETO
    FROM CLIENTE C, PERSONA P
    WHERE C.ID_CLIENTE = P.ID_CLIENTE;


CREATE OR REPLACE VIEW VISTA_EMPLEADO_CONDUCTOR AS
    SELECT E.ID_EMPLEADO, E.TELEFONO, E.NOMBRE_COMPLETO, E.NSS, E.DNI, C.LICENCIA, C.HORAS_SEMANA
    FROM EMPLEADO E, CONDUCTOR C
    WHERE E.ID_EMPLEADO = C.ID_EMPLEADO;

--Son actualizables pq por ej, sobre los clientes puedo hacer actualizaciones facilmente sin q haya problemas de q la bd no sepa donde hacerlos (con empleado y conductor igual).

CREATE OR REPLACE VIEW VISTA_EJECUCION AS
    SELECT E.ID_EJECUCION, E.FECHA_EJECUCION, E.ID_VEHICULO, E.ID_RUTA, EC.ID_EMPLEADO
    FROM EJECUCION E, VEHICULO V, EMPLEADO EM, RUTA R, EJECUCION_CONDUCTOR EC
    WHERE E.ID_VEHICULO = V.ID_VEHICULO AND E.ID_RUTA = R.ID_RUTA AND E.ID_EJECUCION = EC.ID_EJECUCION AND EC.ID_EMPLEADO = EM.ID_EMPLEADO;

--No seria actualizable pq al hacer una actualizacion de cualquier tipo, la bd tendria q trabajar con 5 tablas diferentes, lo q hace que los insert (p.ej) sean complicados, ya q no sabemos donde hacerlo primero.

--CREACION INDICES--
CREATE INDEX IND_VEHICULO_EMPLEADO ON VEHICULO (ID_EMPLEADO);
CREATE INDEX IND_PARADA_RUTA ON PARADA (ID_RUTA);
CREATE INDEX IND_ENVIO_CLIENTE ON ENVIO (ID_CLIENTE);
CREATE INDEX IND_EJECUCION_VEHICULO ON EJECUCION (ID_VEHICULO);
CREATE INDEX IND_EJECUCION_RUTA ON EJECUCION (ID_RUTA);

--CREATE INDEX IND_VEHICULO_MATRICULA ON VEHICULO (MATRICULA) no hace falta pq es unique, por lo q ya tiene indice
CREATE INDEX IND_EMPLEADO_DNI ON EMPLEADO (DNI);
--CREATE INDEX IND_CLIENTE_ID ON CLIENTE (ID_CLIENTE); no pq es PK
--CREATE INDEX IND_EJECUCION_ID ON EJECUCION (ID_EJECUCION) no pq es PK

CREATE INDEX IND_EMPLEADO_NOMBRE ON EMPLEADO (NOMBRE_COMPLETO);
CREATE INDEX IND_CONDUCTOR_HORAS ON CONDUCTOR (HORAS_SEMANA);
--CREATE INDEX IND_CONDUCTOR_HORAS ON CONDUCTOR (HORAS_SEMANA) no pq muchos conductores tienen la misma licencia
CREATE INDEX IND_FECHA ON ENVIO (FECHA);
CREATE INDEX IND_ESTADO ON ENVIO (ESTADO);

CREATE INDEX IND_EJECUCION_VEHICULO_FECHA ON EJECUCION (ID_VEHICULO, FECHA_EJECUCION);
CREATE INDEX IND_EJECUCION_VEHICULO_RUTA ON EJECUCION (ID_VEHICULO, ID_RUTA);
CREATE INDEX IND_PARADA_CIUDAD_RUTA ON PARADA (ID_RUTA, CIUDAD);

CREATE INDEX IND_SUPERVISA_SUPERVISADO ON SUPERVISA (ID_EMPLEADO_SUPERVISADO);
--CREATE INDEX IND_SUPERVISA_SUPERVISOR ON SUPERVISA (ID_EMPLEADO_SUPERVISOR), haria falta????
CREATE INDEX IND_EJEC_CONDUCTOR_EMPLEADO ON EJECUCION_CONDUCTOR (ID_EMPLEADO);

--INSERCIONES--

--Insert para empleado conductor 1--
INSERT into EMPLEADO (ID_EMPLEADO, TELEFONO, NOMBRE_COMPLETO, NSS, DNI) values ('1a2b3c', 111222333, 'Juanito Fernandez Lopez', '12345678901', '12345678a');
INSERT into CONDUCTOR (ID_EMPLEADO, LICENCIA, HORAS_SEMANA) values ('1a2b3c', 'C1', 45);
--Insert para empleado conductor 2--
INSERT into EMPLEADO (ID_EMPLEADO, TELEFONO, NOMBRE_COMPLETO, NSS, DNI) values ('2a2b2c', 123456789, 'Alvarito Perez Gomez', '12345678901', '12345678a');
INSERT into CONDUCTOR (ID_EMPLEADO, LICENCIA, HORAS_SEMANA) values ('2a2b2c', 'C1', 50);
--Insert para empleado conductor 3--
INSERT into EMPLEADO (ID_EMPLEADO, TELEFONO, NOMBRE_COMPLETO, NSS, DNI) values ('3a3b3c', 987654321, 'Manolito Sanchez Lopez', '12345678901', '12345678a');
INSERT into CONDUCTOR (ID_EMPLEADO, LICENCIA, HORAS_SEMANA) values ('3a3b3c', 'C1', 44);
--Insert para mecanico--
INSERT into EMPLEADO (ID_EMPLEADO, TELEFONO, NOMBRE_COMPLETO, NSS, DNI) values ('2b1a3c', 444555666, 'Pepito Gonzalez Lopez', '10987654321', '87654321b');
INSERT into MECANICO (ID_EMPLEADO, ESPECIALIDAD) values ('2b1a3c', 'Carroceria');
--Insert para administrativo--
INSERT into EMPLEADO (ID_EMPLEADO, TELEFONO, NOMBRE_COMPLETO, NSS, DNI) values ('3c2b1a', 777888999, 'Menganito Martinez Lopez', '20987654321', '1357248c');
INSERT into ADMINISTRATIVO (ID_EMPLEADO, DEPARTAMENTO) values ('3c2b1a', 'Contabilidad');

--Vehiculo "normal" sin conductor asignado--
INSERT into GPS (ID_GPS, MODELO, NUM_SERIE) values ('gps1', 'modelo300', '123abc');
INSERT into VEHICULO (ID_VEHICULO, ID_GPS, ID_EMPLEADO, MATRICULA, CAPACIDAD_KG) values ('cam1a', 'gps1', NULL, '1234ABC', 7400);
--Vehiculo "normal" con conductor asignado--
INSERT into GPS (ID_GPS, MODELO, NUM_SERIE) values ('gps2', 'modelo300', '456abc');
INSERT into VEHICULO (ID_VEHICULO, ID_GPS, ID_EMPLEADO, MATRICULA, CAPACIDAD_KG) values ('cam2a', 'gps2', '1a2b3c', '1234CBA', 7400);
--Vehiculo adr--
INSERT into GPS (ID_GPS, MODELO, NUM_SERIE) values ('gps3', 'modelo300', '789abc');
INSERT into VEHICULO (ID_VEHICULO, ID_GPS, ID_EMPLEADO, MATRICULA, CAPACIDAD_KG) values ('cam3a', 'gps3', '2a2b2c', '1234DCB', 7400);
--Vehiculo refrigerado--
INSERT into GPS (ID_GPS, MODELO, NUM_SERIE) values ('gps4', 'modelo300', '147abc');
INSERT into VEHICULO (ID_VEHICULO, ID_GPS, ID_EMPLEADO, MATRICULA, CAPACIDAD_KG) values ('cam4a', 'gps4', '3a3b3c', '1234FCP', 7400);

--Ruta y paradas--
INSERT into RUTA (ID_RUTA, NOMBRE, DISTANCIA_KM) values ('ruta1a', 'Vigo-Ourense', 95);
INSERT into PARADA (N_PARADA, ID_RUTA, CIUDAD, HORAPREVISTA) values ('1', 'ruta1a', 'Ourense', TO_DATE('08:10:00', 'HH24:MI:SS'));
INSERT into PARADA (N_PARADA, ID_RUTA, CIUDAD, HORAPREVISTA) values ('2', 'ruta1a', 'VIGO', TO_DATE('10:10:00', 'HH24:MI:SS'));

--Cliente persona--
INSERT into CLIENTE (ID_CLIENTE, NOMBRE, TELEFONO) values ('cl001', 'Pedro', 656454343);
INSERT into PERSONA (ID_CLIENTE, DNI, NOMBRE_COMPLETO) values ('cl001', '87654321B', 'Pedro Perez Lopez');

--Cliente empresa-
INSERT into CLIENTE (ID_CLIENTE, NOMBRE, TELEFONO) values ('em001', 'Empresa', 987123456);
INSERT into EMPRESA (ID_CLIENTE, NIF, NOMBREEMPRESA) values ('em001', 'B87654321', 'Empresa abc');

--Envio y paquetes--
INSERT into ENVIO (ID_ENVIO, ID_CLIENTE, FECHA, ESTADO) values ('abc123', '123ab', TO_DATE('2025-10-10', 'YYYY-MM-DD'), 'En camino');
INSERT into PAQUETE (N_PAQUETE, ID_ENVIO, PESO, CONTENIDO) values (1, 'abc123', 1000, 'Material peligroso');

--Ejecucion y ejecucion conductor--
INSERT into EJECUCION (ID_EJECUCION, FECHA_EJECUCION, ID_VEHICULO, ID_RUTA) values ('987zy', TO_DATE('2025-10-9', 'YYYY-MM-DD'), 'cam2a', 'ruta1a');
INSERT into EJECUCION_CONDUCTOR (ID_EJECUCION, ID_EMPLEADO) values ('987zy', '1a2b3c');

--Supervisa--

INSERT into SUPERVISA (ID_EMPLEADO_SUPERVISADO, ID_EMPLEADO_SUPERVISOR) values ('2a2b2c', '1a2b3c');
